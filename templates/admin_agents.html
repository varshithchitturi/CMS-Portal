<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Management - Admin Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="header">
        <nav class="nav">
            <a href="{{ url_for('admin_dashboard') }}" class="logo">‚ö° IntelliSupport Admin</a>
            <ul class="nav-links">
                <li><a href="{{ url_for('admin_dashboard') }}">Admin Dashboard</a></li>
                <li><a href="{{ url_for('admin_agents') }}" class="active">Agent Management</a></li>
                <li class="profile-dropdown">
                    <div class="profile-trigger" id="profileTrigger">
                        <div class="profile-avatar admin-avatar">{{ session.full_name[0].upper() }}</div>
                        <span class="profile-name admin-name">{{ session.full_name.split()[0] }}</span>
                        <i class="dropdown-arrow">‚ñº</i>
                    </div>
                    <div class="profile-dropdown-content" id="profileDropdown">
                        <div class="profile-header admin-header">
                            <div class="profile-avatar-large admin-avatar-large">{{ session.full_name[0].upper() }}</div>
                            <div class="profile-info">
                                <h4>{{ session.full_name }}</h4>
                                <p>{{ session.email }}</p>
                                <span class="admin-badge">Administrator</span>
                            </div>
                        </div>
                        <div class="profile-menu">
                            <a href="#" id="profileDetailsLink">üë§ Admin Profile</a>
                            <a href="{{ url_for('admin_dashboard') }}">‚ö° Admin Dashboard</a>
                            <a href="{{ url_for('admin_agents') }}">üë• Agent Management</a>
                            <div class="profile-divider"></div>
                            <a href="{{ url_for('logout') }}" class="logout-link">üö™ Logout</a>
                        </div>
                    </div>
                </li>
            </ul>
        </nav>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">üë• Agent Management System</h2>
                <p class="card-subtitle">Manage support agents and their specializations</p>
            </div>
            
            <div class="agents-grid">
                {% for agent in agents %}
                <div class="agent-card" onclick="viewAgentDetails('{{ agent.id }}')">
                    <div class="agent-header">
                        <div class="agent-avatar">
                            {{ agent.name.split()[0][0] }}{{ agent.name.split()[-1][0] }}
                        </div>
                        <div class="agent-basic-info">
                            <h3 class="agent-name">{{ agent.name }}</h3>
                            <div class="agent-specialization">{{ agent.specialization }}</div>
                            <div class="agent-status status-{{ agent.status.lower() }}">{{ agent.status }}</div>
                        </div>
                    </div>
                    
                    <div class="agent-stats">
                        <div class="stat-item">
                            <span class="stat-value">{{ agent.assigned_tickets }}</span>
                            <span class="stat-label">Active Tickets</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ agent.specialization.split()[0] }}</span>
                            <span class="stat-label">Expertise</span>
                        </div>
                    </div>
                    
                    <div class="agent-description">
                        {{ agent.description[:120] }}{% if agent.description|length > 120 %}...{% endif %}
                    </div>
                    
                    <div class="agent-contact">
                        <div class="contact-item">
                            <span class="contact-icon">üìß</span>
                            <span class="contact-text">{{ agent.email }}</span>
                        </div>
                        <div class="contact-item">
                            <span class="contact-icon">üì±</span>
                            <span class="contact-text">{{ agent.phone }}</span>
                        </div>
                    </div>
                    
                    <div class="agent-actions">
                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); viewAgentDetails('{{ agent.id }}')">
                            üëÅÔ∏è View Details
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); assignTicketsToAgent('{{ agent.name }}')">
                            üìã Assign Tickets
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Quick Actions Panel -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">‚ö° Quick Actions</h3>
            </div>
            
            <div class="quick-actions">
                <div class="action-item">
                    <h4>üéØ Smart Assignment</h4>
                    <p>Automatically assign tickets based on agent specialization and current workload</p>
                    <div class="action-status">
                        <span id="pendingTicketsCount">{{ unassigned_tickets|length if unassigned_tickets else 0 }}</span> pending tickets ready for assignment
                    </div>
                    <button class="btn btn-primary" id="autoAssignBtn" onclick="smartAssignTickets()" 
                            {% if not unassigned_tickets %}disabled{% endif %}>
                        <span class="btn-icon">ü§ñ</span>
                        {% if unassigned_tickets %}Auto-Assign {{ unassigned_tickets|length }} Tickets{% else %}No Tickets to Assign{% endif %}
                    </button>
                </div>
                
                <div class="action-item">
                    <h4>üìä Performance Analysis</h4>
                    <p>Generate detailed performance reports and analytics for all agents</p>
                    <div class="action-status">
                        <span id="totalAgents">{{ agents|length }}</span> agents ‚Ä¢ <span id="totalTickets">{{ total_tickets if total_tickets else 0 }}</span> total tickets processed
                    </div>
                    <button class="btn btn-secondary" id="exportBtn" onclick="exportAnalysis()">
                        <span class="btn-icon">üìà</span>
                        Export Analysis Report
                    </button>
                </div>
                
                <div class="action-item">
                    <h4>üîÑ Load Balancing</h4>
                    <p>Redistribute tickets to balance workload across active agents</p>
                    <div class="action-status">
                        <span id="activeAgents">{{ active_agents_count if active_agents_count else 0 }}</span> active agents ‚Ä¢ Workload variance: <span id="workloadVariance">Calculating...</span>
                    </div>
                    <button class="btn btn-warning" id="balanceBtn" onclick="balanceWorkload()">
                        <span class="btn-icon">‚öñÔ∏è</span>
                        Balance Workload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Assignment Modal -->
    <div id="assignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Assign Tickets to Agent</h3>
                <span class="close" onclick="closeModal('assignModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Agent:</label>
                    <select id="selectedAgent" class="form-control">
                        {% for agent in agents %}
                        <option value="{{ agent.name }}">{{ agent.name }} - {{ agent.specialization }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Available Tickets:</label>
                    <div id="availableTickets" class="ticket-list">
                        <!-- Tickets will be loaded dynamically -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="confirmAssignment()">Assign Selected</button>
                <button class="btn btn-secondary" onclick="closeModal('assignModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        
        function viewAgentDetails(agentId) {
            window.location.href = `/admin/agent/${agentId}`;
        }

        function assignTicketsToAgent(agentName) {
            document.getElementById('selectedAgent').value = agentName;
            loadAvailableTickets();
            document.getElementById('assignModal').style.display = 'block';
        }

        function loadAvailableTickets() {
            // Load unassigned tickets
            fetch('/api/unassigned_tickets')
                .then(response => response.json())
                .then(tickets => {
                    const container = document.getElementById('availableTickets');
                    container.innerHTML = '';
                    
                    tickets.forEach(ticket => {
                        const ticketElement = document.createElement('div');
                        ticketElement.className = 'ticket-item';
                        ticketElement.innerHTML = `
                            <input type="checkbox" id="ticket_${ticket.ticket_id}" value="${ticket.ticket_id}">
                            <label for="ticket_${ticket.ticket_id}">
                                <strong>${ticket.ticket_id}</strong> - ${ticket.title}
                                <span class="priority-badge priority-${ticket.priority.toLowerCase()}">${ticket.priority}</span>
                                <span class="category-badge">${ticket.category}</span>
                            </label>
                        `;
                        container.appendChild(ticketElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading tickets:', error);
                    showNotification('Error loading available tickets', 'error');
                });
        }

        function confirmAssignment() {
            const agentName = document.getElementById('selectedAgent').value;
            const selectedTickets = Array.from(document.querySelectorAll('#availableTickets input:checked'))
                .map(cb => cb.value);
            
            if (selectedTickets.length === 0) {
                showNotification('Please select at least one ticket', 'warning');
                return;
            }

            // Assign tickets
            Promise.all(selectedTickets.map(ticketId => 
                fetch('/admin/assign_ticket', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticket_id: ticketId, agent_name: agentName })
                })
            )).then(() => {
                showNotification(`${selectedTickets.length} tickets assigned to ${agentName}`, 'success');
                closeModal('assignModal');
                setTimeout(() => location.reload(), 1000);
            }).catch(error => {
                console.error('Error assigning tickets:', error);
                showNotification('Error assigning tickets', 'error');
            });
        }

        function smartAssignTickets() {
            const btn = document.getElementById('autoAssignBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Assigning...';
            
            fetch('/api/tickets/auto-assign', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.success) {
                        showNotification(`‚úÖ Successfully assigned ${result.assigned_count} tickets to agents`, 'success');
                        updatePendingCount(result.remaining_pending || 0);
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showNotification('‚ùå Error in smart assignment: ' + (result.error || result.message || 'Unknown error'), 'error');
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                })
                .catch(error => {
                    console.error('Error in smart assignment:', error);
                    showNotification('‚ùå Network error during smart assignment: ' + error.message, 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                });
        }

        function exportAnalysis() {
            const btn = document.getElementById('exportBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Generating...';
            
            // Simulate analysis generation (replace with actual implementation)
            setTimeout(() => {
                const analysisData = generateAnalysisReport();
                downloadCSV(analysisData, 'agent_performance_analysis.csv');
                showNotification('üìä Analysis report exported successfully!', 'success');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }, 2000);
        }

        function balanceWorkload() {
            const btn = document.getElementById('balanceBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Balancing...';
            
            // Simulate workload balancing (replace with actual API call)
            fetch('/admin/balance_workload', { method: 'POST' })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showNotification(`‚öñÔ∏è Workload balanced successfully. ${result.reassigned_count || 0} tickets reassigned`, 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        showNotification('‚ùå Error balancing workload: ' + (result.message || 'Unknown error'), 'error');
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                })
                .catch(error => {
                    console.error('Error balancing workload:', error);
                    showNotification('‚ùå Network error during workload balancing', 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                });
        }

        function updatePendingCount(count) {
            document.getElementById('pendingTicketsCount').textContent = count;
            const btn = document.getElementById('autoAssignBtn');
            if (count === 0) {
                btn.disabled = true;
                btn.innerHTML = '<span class="btn-icon">‚úÖ</span>No Tickets to Assign';
            }
        }

        function generateAnalysisReport() {
            const agents = {{ agents|tojson }};
            let csvContent = "Agent Name,Email,Specialization,Active Tickets,Total Assigned,Status\\n";
            
            agents.forEach(agent => {
                csvContent += `"${agent.name}","${agent.email}","${agent.specialization}","${agent.assigned_tickets}","${agent.total_tickets || 0}","${agent.status}"\\n`;
            });
            
            return csvContent;
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function calculateWorkloadVariance() {
            const agents = {{ agents|tojson }};
            const activeAgents = agents.filter(agent => agent.status === 'Active');
            
            if (activeAgents.length === 0) {
                document.getElementById('workloadVariance').textContent = 'No active agents';
                return;
            }
            
            const workloads = activeAgents.map(agent => agent.assigned_tickets || 0);
            const avg = workloads.reduce((a, b) => a + b, 0) / workloads.length;
            const variance = workloads.reduce((acc, val) => acc + Math.pow(val - avg, 2), 0) / workloads.length;
            const stdDev = Math.sqrt(variance);
            
            let status = 'Balanced';
            if (stdDev > 3) status = 'High variance';
            else if (stdDev > 1.5) status = 'Medium variance';
            
            document.getElementById('workloadVariance').textContent = status;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        }
        
        // Profile dropdown functionality
        function toggleProfileDropdown(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            console.log('Toggle profile dropdown called'); // Debug log
            const dropdown = document.querySelector('.profile-dropdown');
            
            if (!dropdown) {
                console.error('Profile dropdown element not found');
                return;
            }
            
            // Close any other open dropdowns first
            document.querySelectorAll('.profile-dropdown.active').forEach(dd => {
                if (dd !== dropdown) {
                    dd.classList.remove('active');
                }
            });
            
            // Toggle dropdown with immediate effect
            const isCurrentlyActive = dropdown.classList.contains('active');
            
            if (isCurrentlyActive) {
                dropdown.classList.remove('active');
                console.log('Dropdown closed');
            } else {
                dropdown.classList.add('active');
                console.log('Dropdown opened');
            }
            
            return false; // Prevent default behavior
        }
        
        // Handle profile details display
        function showProfileDetails(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            console.log('Show profile details called');
            
            // Display the admin profile modal
            document.getElementById('adminProfileModal').style.display = 'block';
            document.querySelector('.profile-dropdown').classList.remove('active');
            toggleProfileDropdown(event);
        }
        
        // Handle profile trigger clicks
        function handleProfileTriggerClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Profile trigger clicked via event listener');
            toggleProfileDropdown(e);
        }
        
        // Handle profile details click
        function handleProfileDetailsClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Profile details link clicked via event listener');
            showProfileDetails(e);
        }
        
        // Initialize page functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin agents page loaded');
            
            // Initialize data
            calculateWorkloadVariance();
            
            // Add click handler for profile dropdown
            const profileTrigger = document.getElementById('profileTrigger');
            if (profileTrigger) {
                console.log('Profile trigger found, adding event listener');
                
                // Remove any existing listeners and add new one
                profileTrigger.removeEventListener('click', handleProfileTriggerClick);
                profileTrigger.addEventListener('click', handleProfileTriggerClick);
            } else {
                console.error('Profile trigger not found');
            }
            
            // Add click handler for profile details link
            const profileDetailsLink = document.getElementById('profileDetailsLink');
            if (profileDetailsLink) {
                profileDetailsLink.removeEventListener('click', handleProfileDetailsClick);
                profileDetailsLink.addEventListener('click', handleProfileDetailsClick);
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const dropdown = document.querySelector('.profile-dropdown');
                if (dropdown && !dropdown.contains(event.target)) {
                    dropdown.classList.remove('active');
                }
            });
            
            const dropdownContent = document.querySelector('.profile-dropdown-content');
            if (dropdownContent) {
                dropdownContent.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        });
        
        function hideAdminProfile() {
            document.getElementById('adminProfileModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        };
    </script>
    
    <!-- Admin Profile Modal -->
    <div id="adminProfileModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>üë®‚Äçüíº Administrator Profile</h3>
                <span class="close" onclick="hideAdminProfile()">&times;</span>
            </div>
            <div class="profile-details">
                <div class="profile-section">
                    <div class="profile-avatar-xl admin-avatar-xl" id="adminProfileAvatar">{{ session.full_name[0].upper() }}</div>
                    <h3 id="adminProfileFullName">{{ session.full_name }}</h3>
                    <p style="color: #666;" id="adminProfileMemberSince">Administrator</p>
                </div>
                
                <div class="profile-info-grid">
                    <div class="info-item">
                        <label>üë§ Username</label>
                        <p id="adminProfileUsername">{{ session.full_name }}</p>
                    </div>
                    <div class="info-item">
                        <label>üìß Email Address</label>
                        <p id="adminProfileEmail">{{ session.email }}</p>
                    </div>
                    <div class="info-item">
                        <label>üè† Full Name</label>
                        <p id="adminProfileDisplayName">{{ session.full_name }}</p>
                    </div>
                    <div class="info-item">
                        <label>üì± Phone Number</label>
                        <p id="adminProfilePhone">Not Available</p>
                    </div>
                    <div class="info-item">
                        <label>üîê Access Level</label>
                        <p><span class="admin-badge">Administrator</span></p>
                    </div>
                    <div class="info-item">
                        <label>üÜî Admin ID</label>
                        <p>{{ session.user_id }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
